name: Apply file blocks from Issue -> MAIN

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  apply:
    runs-on: ubuntu-latest
    env:
      OWNER: ${{ github.repository_owner }}
      REPO:  ${{ github.event.repository.name }}
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      # Парсим комментарий/issue телом: ищем блоки ```file:relative/path\n<content>\n```
      - name: Extract file blocks
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = (context.payload.comment?.body || context.payload.issue?.body || '').replace(/\r\n/g, '\n');
            const re = /```file:\s*([^\n]+)\n([\s\S]*?)```/g;
            let i = 0, m;
            while ((m = re.exec(body)) !== null) {
              i++;
              fs.writeFileSync(`path${String(i).padStart(3,'0')}.txt`, m[1].trim());
              fs.writeFileSync(`data${String(i).padStart(3,'0')}.txt`, m[2]);
            }
            core.setOutput('found', String(i));

      - name: Apply non-workflow files (GITHUB_TOKEN)
        if: steps.extract.outputs.found != '0'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "agent-bot"
          git config user.email "agent@users.noreply.github.com"

          changed=0
          for p in path*.txt; do
            i=${p##path}; i=${i%%.txt}
            path=$(cat "path${i}.txt")
            case "$path" in
              .github/workflows/*) continue ;;
            esac
            mkdir -p "$(dirname "$path")"
            cp "data${i}.txt" "$path"
            echo "Wrote $path"
            git add "$path"
            changed=1
          done

          if [ "$changed" = "1" ]; then
            git commit -m "chore(agent): apply non-workflow files from issue"
            git push origin HEAD:main
          else
            echo "No non-workflow files to push."
          fi

      - name: Apply workflow files (push with PAT)
        if: steps.extract.outputs.found != '0'
        env:
          PUSH_URL: ${{ format('https://x-access-token:{0}@github.com/{1}.git', secrets.WORKFLOW_TOKEN, github.repository) }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${PUSH_URL:-}" ]; then
            echo "WORKFLOW_TOKEN not set; skipping workflow updates."
            exit 0
          fi

          git config user.name  "agent-bot"
          git config user.email "agent@users.noreply.github.com"
          # КЛЮЧЕВОЕ: заменяем origin на URL с PAT
          git remote set-url origin "$PUSH_URL"

          changed=0
          for p in path*.txt; do
            i=${p##path}; i=${i%%.txt}
            path=$(cat "path${i}.txt")
            case "$path" in
              .github/workflows/*)
                mkdir -p "$(dirname "$path")"
                cp "data${i}.txt" "$path"
                echo "Wrote workflow file: $path"
                git add "$path"
                changed=1
                ;;
            esac
          done

          if [ "$changed" = "1" ]; then
            git commit -m "chore(agent): apply workflow files from issue"
            # теперь origin = PAT-URL → пуш с нужными правами
            git push origin HEAD:main
          else
            echo "No workflow files to push with PAT."
          fi